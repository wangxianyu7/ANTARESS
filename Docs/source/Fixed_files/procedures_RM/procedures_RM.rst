.. raw:: html

    <style> .orange {color:DarkOrange} </style>

.. role:: orange

.. raw:: html

    <style> .green {color:green} </style>

.. role:: green

.. raw:: html

    <style> .Magenta {color:Magenta} </style>

.. role:: Magenta

Rossiter McLaughlin analysis
============================

This tutorial relates to the analysis of a Rossiter McLaughlin signal from a transiting planet, using the *Revolutions* technique (`Bourrier et al. 2021 <https://www.aanda.org/articles/aa/full_html/2021/10/aa41527-21/aa41527-21.html>`_). We illustrate the tutorial with ESPRESSO observations of TOI-421b (2022-11-17) and TOI-421c (2023-11-06). 
Additional options beyond the present example can be found in the `configuration file <LINK TBD>`_.

We assume here that you have already `set up your system <https://obswww.unige.ch/~bourriev/antaress/doc/html/Fixed_files/procedures_setup/procedures_setup.html>`_, processed a `spectral transit time-series <https://obswww.unige.ch/~bourriev/antaress/doc/html/Fixed_files/procedures_reduc/procedures_reduc.html>`_, extracted `planet-occulted stellar profiles <TBD>`_, and 
converted them into `intrinsic CCFs <https://obswww.unige.ch/~bourriev/antaress/doc/html/Fixed_files/procedures_CCF/procedures_CCF_Intr/procedures_CCF_Intr.html>`_.

Analysis of individual intrinsic CCFs
-------------------------------------

The goal of this step is to fit a model line profile to each intrinsic CCF, deriving series of line properties that will then be used to identify which exposures should be included in the RM Revolutions fit, and what are the best models to be used.

Activate the ``Intrinsic profiles analysis`` module by setting::

 gen_dic['fit_Intr'] = True
 
First, define the velocity range that you assume to represent the line continuum::

 data_dic['Intr']['cont_range'] = {'ESPRESSO':{0:[[-60,-20],[20,60]]}
 
Then, define the velocity range over which the line model is fitted. You can use specific ranges for each visit, in case the line is affected by spurious feature in some of them. Here this is not the case, and we set::

 data_dic['Intr']['fit_range']= {'ESPRESSO':{'20231106':[[-60,60]]}

Both continuum and fitted ranges are defined in the star rest frame, and specific to a given instrument because the measured line width depends on the spectrograph broadening. 
The ranges can be made of several independent intervals, so that you can exclude features that are not captured by your line model. 
If left  undefined, the ranges are set to default values based on the value you provided for the stellar rotational velocity. It is advised to define specific values for your datasets, by looking at the time series of plotted intrinsic profiles generated by activating:: 

 plot_dic['Intr_prof']='pdf'
 
Such plots (e.g., :numref:`Intrinsic_CCF`) can be found in :orange:`Working_dir/Star/Planet_Plots/Intr_data/Instrument_Visit_Indiv/Data/`.  

.. figure:: Intrinsic_CCF.png
  :width: 800
  :name: Intrinsic_CCF
  
  Intrinsic CCF occulted by TOI-421c. Blue shaded areas indicate the continuum ranges. Grey shaded areas are excluded from the fit.


.. Tip::
   For slow rotators the disk-integrated and intrinsic lines will have similar shapes. You can thus use fitting and continuum ranges based on the disk-integrated line profile, which is particularly useful when the intrinsic line is measured at low S/R and not visible by eye.
   On the other hand, for fast rotators you will want to use narrower ranges for the intrinsic line than for the disk-integrated line.


Next, define the best model for the line profile. Intrinsic stellar lines are typically well described by the default Gaussian model, which would otherwise be set up as:: 

 data_dic['Intr']['model']['ESPRESSO']='gauss' 

.. Tip::
   If the stellar line is not well visible in individual intrinsic profiles, you can determine its shape by analyzing a higher S/N master  of all intrinsic profiles along the transit chord.

We advise applying instrumental convolution to the line model::

 data_dic['Intr']['conv_model']=True 
 
In that case the properties that you will derive from the fit will correspond to the model line profile before convolution. This is particularly useful to trace the *intrinsic* line properties, and compare results between different instruments and with theoretical predictions.
Model properties are set up through:: 

 data_dic['Intr']['mod_prop']={'rv':{'vary':True,'ESPRESSO':{'20231106':{'guess':0.,'bd':[-2.,2.]}}},
                               'ctrst':{'vary':True,'ESPRESSO':{'20231106':{'guess':0.5,'bd':[0.2,0.9]}}},
                               'FWHM':{'vary':True,'ESPRESSO':{'20231106':{'guess':8.,'bd':[0.,15.]}}}}  

Since we are using a Gaussian model, its profile is determined by the line radial velocity centroid (:green:`rv`), contrast (:green:`ctrst`), and full width at half maximum (:green:`FWHM`). Different models implemented in `Ã€NTARESS`` would require additional or different properties. 
Here we are fitting for the three properties, but you could decide to fix one to the value of :green:`guess` by setting :green:`vary = False`.

 



This will return the rv, FWHM, and contrast time-series of the average stellar line from regions occulted along the transit chord, which you can visualize below. 

Intrinsic CCFs are usually measured with low S/N. In that case, you can run the fits using a MCMC (`fit_mode = "MCMC"`) rather than the default least-square minimization (`fit_mode = "chi2"`). To overwrite the default priors, you can further uncomment the `priors` field and define the lower and upper boundary of the uniform prior ranges. Look at the time-series of properties plotted below to adjust the priors, or at the MCMC chains and corner plots in the directories `/Working_dir/planet_Saved_data/Introrig_prop/instrument_night_mcmc/iexp*/`. Since running the MCMC may take some time, you can set `calc_fit` to `False` once the MCMC is done and you only want to manipulate the plots.

This step is used to identify which exposures should be included in the RM Revolutions fit, by assessing the quality of intrinsic CCFs. The derived stellar line properties can further be analyzed in the next step. Additional stellar line models and fit options are available through the configuration file. 



Run this cell to perform a Gaussian fit to each intrinsic CCF. This will return the rv, FWHM, and contrast time-series of the average stellar line from regions occulted along the transit chord, which you can visualize below. 

Intrinsic CCFs are usually measured with low S/N. In that case, you can run the fits using a MCMC (`fit_mode = "MCMC"`) rather than the default least-square minimization (`fit_mode = "chi2"`). To overwrite the default priors, you can further uncomment the `priors` field and define the lower and upper boundary of the uniform prior ranges. Look at the time-series of properties plotted below to adjust the priors, or at the MCMC chains and corner plots in the directories `/Working_dir/planet_Saved_data/Introrig_prop/instrument_night_mcmc/iexp*/`. Since running the MCMC may take some time, you can set `calc_fit` to `False` once the MCMC is done and you only want to manipulate the plots.

Advanced settings:


Tip:



Analysis of intrinsic line properties
-------------------------------------